<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ChessVerse - Locale</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{margin:0;font-family:'Noto Sans',system-ui,sans-serif;background:#312e2b;color:#fff;overflow-x:hidden}
        /* HEADER */
        .header{background:#262522;border-bottom:1px solid #3d3d3d;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;position:sticky;top:0;z-index:50}
        .header-left{display:flex;align-items:center;gap:32px}
        .logo{font-size:24px;font-weight:700;color:#8b4d8b;text-decoration:none}
        .nav-links{display:flex;gap:24px}
        .nav-links a{color:#b9b9b9;text-decoration:none;font-weight:500;font-size:14px;padding:8px 12px;border-radius:4px;transition:.2s}
        .nav-links a:hover,.nav-links a.active{color:#fff;background:#3d3d3d}
        .header-right{display:flex;align-items:center;gap:8px}
        .btn{padding:8px 14px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:.2s;font-family:inherit;font-size:14px}
        .btn-primary{background:#8b4d8b;color:#fff}.btn-primary:hover{background:#7a427a}
        .btn-ghost{background:#3d3d3d;color:#fff}.btn-ghost:hover{background:#4a4a4a}
        /* LAYOUT */
        main{max-width:1200px;margin:0 auto;padding:24px 16px;display:flex;gap:32px;flex-wrap:wrap}
        .game-area{flex:1 1 560px;display:flex;flex-direction:column;align-items:center;gap:16px}
        .board-wrapper{position:relative}
        .board-container{position:relative}
        /* BOARD */
        #chessboard.chessboard{--board-size:560px;width:var(--board-size);height:var(--board-size);border:3px solid #8b4d8b;border-radius:4px;display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(8,1fr);--board-light:#f0d9b5;--board-dark:#b58863;background:linear-gradient(135deg,var(--board-light) 0%,var(--board-dark) 100%);box-shadow:0 4px 12px rgba(0,0,0,.3);position:relative}
        .square{position:relative;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;overflow:hidden}
        .square.light{background:var(--board-light)}.square.dark{background:var(--board-dark)}
        .square.invalid{animation:flash .35s linear}@keyframes flash{0%{filter:brightness(2)}100%{filter:none}}
        .last-move::after{content:"";position:absolute;inset:0;background:rgba(247,247,105,0.35);pointer-events:none;z-index:1}
        /* PIECES (SVG background like /play) */
        .piece{width:85%;height:85%;background-size:contain;background-repeat:no-repeat;background-position:center;cursor:grab;transition:transform .1s;z-index:10}
        .piece:hover{transform:scale(1.08)}.piece.dragging{cursor:grabbing;transform:scale(1.18);z-index:1000;pointer-events:none}
        /* White pieces */
        .piece.white.king{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'%3e%3cg fill='%23fff' fill-rule='evenodd' stroke='%23000' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M22.5 11.63V6'/%3e%3cpath d='M20 8h5' stroke-linecap='butt'/%3e%3cpath d='M22.5 25s4.5-7.5 3-10.5c0 0-1-2.5-3-2.5s-3 2.5-3 2.5c-1.5 3 3 10.5 3 10.5' fill='%23fff' stroke-linecap='butt' stroke-linejoin='miter'/%3e%3cpath d='M11.5 37c5.5 3.5 15.5 3.5 21 0v-7s9-4.5 6-10.5c-4-6.5-13.5-3.5-16 4V27v-3.5c-3.5-7.5-13-10.5-16-4-3 6 5 10 5 10V37z' fill='%23fff'/%3e%3cpath d='M11.5 30c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0' stroke='%23000'/%3e%3c/g%3e%3c/svg%3e")}
        .piece.white.queen{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'%3e%3cg fill='%23fff' fill-rule='evenodd' stroke='%23000' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M8 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM24.5 7.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM41 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM16 8.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM33 9a2 2 0 1 1-4 0 2 2 0 1 1 4 0z'/%3e%3cpath d='M9 26c8.5-1.5 21-1.5 27 0l2-12-7 11V11l-5.5 13.5-3-15-3 15-5.5-13.5V25L7 14l2 12z' stroke-linecap='butt'/%3e%3cpath d='M9 26c0 2 1.5 2 2.5 4 1 1.5 1 1 .5 3.5-1.5 1-1.5 2.5-1.5 2.5-1.5 1.5.5 2.5.5 2.5 6.5 1 16.5 1 23 0 0 0 1.5-1 0-2.5 0 0 .5-1.5-1-2.5-.5-2.5-.5-2 .5-3.5 1-2 2.5-2 2.5-4-8.5-1.5-18.5-1.5-27 0z' stroke-linecap='butt'/%3e%3cpath d='M11.5 30c3.5-1 18.5-1 22 0M12 33.5c6-1 15-1 21 0' fill='none'/%3e%3c/g%3e%3c/svg%3e")}
        .piece.white.rook{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'%3e%3cg fill='%23fff' fill-rule='evenodd' stroke='%23000' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M9 39h27v-3H9v3zM12 36v-4h21v4H12zM11 14V9h4v2h5V9h5v2h5V9h4v5' stroke-linecap='butt'/%3e%3cpath d='M34 14l-3 3H14l-3-3'/%3e%3cpath d='M31 17v12.5H14V17' stroke-linecap='butt' stroke-linejoin='miter'/%3e%3cpath d='M31 29.5l1.5 2.5h-20l1.5-2.5'/%3e%3cpath d='M11 14h23' fill='none' stroke-linejoin='miter'/%3e%3c/g%3e%3c/svg%3e")}
        .piece.white.bishop{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'%3e%3cg fill='none' fill-rule='evenodd' stroke='%23000' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cg fill='%23fff' stroke-linecap='butt'%3e%3cpath d='M9 36c3.39-.97 10.11.43 13.5-2 3.39 2.43 10.11 1.03 13.5 2 0 0 1.65.54 3 2-.68.97-1.65.99-3 .5-3.39-.97-10.11.46-13.5-1-3.39 1.46-10.11.03-13.5 1-1.354.49-2.323.47-3-.5 1.354-1.94 3-2 3-2zM15 32c2.5 2.5 12.5 2.5 15 0 .5-1.5 0-2 0-2 0-2.5-2.5-4-2.5-4 5.5-1.5 6-11.5-5-15.5-11 4-10.5 14-5 15.5 0 0-2.5 1.5-2.5 4 0 0-.5.5 0 2zM25 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z'/%3e%3c/g%3e%3cpath d='M17.5 26h10M15 30h15m-7.5-14.5v5M20 18h5' stroke-linejoin='miter'/%3e%3c/g%3e%3c/svg%3e")}
        .piece.white.knight{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'%3e%3cg fill='none' fill-rule='evenodd' stroke='%23000' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M22 10c10.5 1 16.5 8 16 29H15c0-9 10-6.5 8-21' fill='%23fff'/%3e%3cpath d='M24 18c.38 2.91-5.55 7.37-8 9-3 2-2.82 4.34-5 4-1.042-.94 1.41-3.04 0-3-1 0 .19 1.23-1 2-1 0-4.003 1-4-4 0-2 6-12 6-12s1.89-1.9 2-3.5c-.73-.994-.5-2-.5-3 1-1 3 2.5 3 2.5h2s.78-1.992 2.5-3c1 0 1 3 1 3' fill='%23fff'/%3e%3cpath d='M9.5 25.5a.5.5 0 1 1-1 0 .5.5 0 1 1 1 0zM14.933 15.75a.5 1.5 30 1 1-.866-.5.5 1.5 30 1 1 .866.5z' fill='%23000'/%3e%3c/g%3e%3c/svg%3e")}
        .piece.white.pawn{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'%3e%3cpath d='M22.5 9c-2.21 0-4 1.79-4 4 0 .89.29 1.71.78 2.38C17.33 16.5 16 18.59 16 21c0 2.03.94 3.84 2.41 5.03-3 1.06-7.41 5.55-7.41 13.47h23c0-7.92-4.41-12.41-7.41-13.47 1.47-1.19 2.41-3 2.41-5.03 0-2.41-1.33-4.5-3.28-5.62.49-.67.78-1.49.78-2.38 0-2.21-1.79-4-4-4z' fill='%23fff' stroke='%23000' stroke-width='1.5' stroke-linecap='round'/%3e%3c/svg%3e")}
        /* Black pieces */
        .piece.black.king{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'%3e%3cg fill='%23000' fill-rule='evenodd' stroke='%23000' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M22.5 11.63V6' stroke='%23000'/%3e%3cpath d='M22.5 25s4.5-7.5 3-10.5c0 0-1-2.5-3-2.5s-3 2.5-3 2.5c-1.5 3 3 10.5 3 10.5' fill='%23000' stroke-linecap='butt' stroke-linejoin='miter'/%3e%3cpath d='M11.5 37c5.5 3.5 15.5 3.5 21 0v-7s9-4.5 6-10.5c-4-6.5-13.5-3.5-16 4V27v-3.5c-3.5-7.5-13-10.5-16-4-3 6 5 10 5 10V37z' fill='%23000'/%3e%3cpath d='M20 8h5' stroke='%23000' stroke-linecap='butt'/%3e%3cpath d='M32 29.5s8.5-4 6.03-9.65C34.15 14 25 18 22.5 24.5l.01 2.1-.01-2.1C20 18 9.906 14 6.997 19.85c-2.497 5.65 4.853 9 6.853 9.65' stroke='%23fff'/%3e%3cpath d='M11.5 30c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0m-21 3.5c5.5-3 15.5-3 21 0' stroke='%23fff'/%3e%3c/g%3e%3c/svg%3e")}
        .piece.black.queen { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'%3e%3cg fill='%23000' fill-rule='evenodd' stroke='%23000' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M8 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM24.5 7.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM41 12a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM16 8.5a2 2 0 1 1-4 0 2 2 0 1 1 4 0zM33 9a2 2 0 1 1-4 0 2 2 0 1 1 4 0z'/%3e%3cpath d='M9 26c8.5-1.5 21-1.5 27 0l2-12-7 11V11l-5.5 13.5-3-15-3 15-5.5-13.5V25L7 14l2 12z' stroke-linecap='butt'/%3e%3cpath d='M9 26c0 2 1.5 2 2.5 4 1 1.5 1 1 .5 3.5-1.5 1-1.5 2.5-1.5 2.5-1.5 1.5.5 2.5.5 2.5 6.5 1 16.5 1 23 0 0 0 1.5-1 0-2.5 0 0 .5-1.5-1-2.5-.5-2.5-.5-2 .5-3.5 1-2 2.5-2 2.5-4-8.5-1.5-18.5-1.5-27 0z' stroke-linecap='butt'/%3e%3cpath d='M11.5 30c3.5-1 18.5-1 22 0M12 33.5c6-1 15-1 21 0' fill='none'/%3e%3c/g%3e%3c/svg%3e"); }
        .piece.black.rook{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'%3e%3cg fill='%23000' fill-rule='evenodd' stroke='%23000' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M9 39h27v-3H9v3zM12.5 32l1.5-2.5h17l1.5 2.5h-20zM12 36v-4h21v4H12z' stroke-linecap='butt'/%3e%3cpath d='M14 29.5v-13h17v13H14z' stroke-linecap='butt' stroke-linejoin='miter'/%3e%3cpath d='M14 16.5L11 14h23l-3 2.5H14zM11 14V9h4v2h5V9h5v2h5V9h4v5H11z' stroke-linecap='butt'/%3e%3cpath d='M12 35.5h21M13 31.5h19M14 29.5h17M14 16.5h17M11 14h23' fill='none' stroke='%23fff' stroke-width='1' stroke-linejoin='miter'/%3e%3c/g%3e%3c/svg%3e")}
        .piece.black.bishop{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'%3e%3cg fill='none' fill-rule='evenodd' stroke='%23000' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cg fill='%23000' stroke-linecap='butt'%3e%3cpath d='M9 36c3.39-.97 10.11.43 13.5-2 3.39 2.43 10.11 1.03 13.5 2 0 0 1.65.54 3 2-.68.97-1.65.99-3 .5-3.39-.97-10.11.46-13.5-1-3.39 1.46-10.11.03-13.5 1-1.354.49-2.323.47-3-.5 1.354-1.94 3-2 3-2zM15 32c2.5 2.5 12.5 2.5 15 0 .5-1.5 0-2 0-2 0-2.5-2.5-4-2.5-4 5.5-1.5 6-11.5-5-15.5-11 4-10.5 14-5 15.5 0 0-2.5 1.5-2.5 4 0 0-.5.5 0 2zM25 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 1 1 5 0z'/%3e%3c/g%3e%3cpath d='M17.5 26h10M15 30h15m-7.5-14.5v5M20 18h5' stroke='%23fff' stroke-linejoin='miter'/%3e%3c/g%3e%3c/svg%3e")}
        .piece.black.knight{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'%3e%3cg fill='none' fill-rule='evenodd' stroke='%23000' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M22 10c10.5 1 16.5 8 16 29H15c0-9 10-6.5 8-21' fill='%23000'/%3e%3cpath d='M24 18c.38 2.91-5.55 7.37-8 9-3 2-2.82 4.34-5 4-1.042-.94 1.41-3.04 0-3-1 0 .19 1.23-1 2-1 0-4.003 1-4-4 0-2 6-12 6-12s1.89-1.9 2-3.5c-.73-.994-.5-2-.5-3 1-1 3 2.5 3 2.5h2s.78-1.992 2.5-3c1 0 1 3 1 3' fill='%23000'/%3e%3cpath d='M9.5 25.5a.5.5 0 1 1-1 0 .5.5 0 1 1 1 0zM14.933 15.75a.5 1.5 30 1 1-.866-.5.5 1.5 30 1 1 .866.5z' fill='%23fff' stroke='%23fff'/%3e%3cpath d='M24.55 10.4l-.45 1.45.5.15c3.15 1 5.65 2.49 7.9 6.75S35.75 29.06 35.25 39l-.05.5h2.25l.05-.5c.5-10.06-.88-16.85-3.25-21.34-2.37-4.49-5.79-6.64-9.19-7.16l-.51-.1z' fill='%23fff' stroke='none'/%3e%3c/g%3e%3c/svg%3e")}
        .piece.black.pawn{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 45'%3e%3cpath d='M22.5 9c-2.21 0-4 1.79-4 4 0 .89.29 1.71.78 2.38C17.33 16.5 16 18.59 16 21c0 2.03.94 3.84 2.41 5.03-3 1.06-7.41 5.55-7.41 13.47h23c0-7.92-4.41-12.41-7.41-13.47 1.47-1.19 2.41-3 2.41-5.03 0-2.41-1.33-4.5-3.28-5.62.49-.67.78-1.49.78-2.38 0-2.21-1.79-4-4-4z' fill='%23000' stroke='%23000' stroke-width='1.5' stroke-linecap='round'/%3e%3c/svg%3e")}
        /* STATUS & CONTROLS */
        #game-status{min-height:28px;font-size:15px;font-weight:600}
        .controls{display:flex;gap:8px}
        /* PROMO / GAME OVER */
    .dialog-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:10000}
        .dialog{background:#1f1f1f;padding:24px 28px;border:1px solid #3d3d3d;border-radius:12px;width:320px;text-align:center}
        .promotion-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:16px}
        .promo-choice{background:#2c2c2c;padding:12px 0;border-radius:8px;font-size:34px;cursor:pointer;transition:background .15s}
        .promo-choice:hover{background:#3a3a3a}
    /* Annotation canvas for arrows & highlights - sit above pieces but below overlays/menus */
    #annotations-canvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:20;}
    .square.arrow-remove-start::after{content:"";position:absolute;inset:0;box-shadow:inset 0 0 0 4px rgba(255,0,0,.65);border-radius:2px;pointer-events:none;z-index:20;}
    /* Evidenziazioni stile /play - above pieces (z-index:10) but below dialog overlays */
    .square.selected::before{content:"";position:absolute;inset:0;background:rgba(139,77,139,0.28);box-shadow:inset 0 0 0 4px #8b4d8b;pointer-events:none;z-index:20;}
    .square.last-move:not(.selected)::before{content:"";position:absolute;inset:0;background:rgba(247,247,105,0.35);pointer-events:none;z-index:20;}
    /* Mosse legali: pallino su casa vuota */
    .square.possible-move:not(.occupied)::after{content:"";position:absolute;width:34%;height:34%;background:rgba(0,0,0,0.55);border-radius:50%;box-shadow:0 0 0 4px rgba(255,255,255,0.35);pointer-events:none;}
    /* Mosse legali: cattura (pezzo presente) */
    .square.possible-move.occupied::after{content:"";position:absolute;inset:0;box-shadow:inset 0 0 0 6px rgba(255,255,255,0.28),inset 0 0 0 12px rgba(139,77,139,0.35);background:rgba(255,255,255,0.10);border-radius:4px;pointer-events:none;}
    /* projected ghost piece used for premoves (match /bot) */
    .projected-piece{width:85%;height:85%;background-size:contain;background-repeat:no-repeat;background-position:center;opacity:1;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(.98);pointer-events:none;z-index:25}
    /* When a premove is queued, hide the original piece at its origin so only the projected ghost is visible */
    .square.premove-origin .piece{visibility:hidden}
        /* SETTINGS MODAL (minimal) */
        #settingsOverlay{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.75);
            display:none;
            z-index:3000;
            overflow:auto;
            align-items:flex-start;
            justify-content:center;
            padding-top:60px;
            padding-bottom:60px;
        }
        #settingsOverlay .settings-modal{background:#262421;margin:60px auto;padding:24px;border-radius:12px;max-width:900px;width:90%;color:#fff;border:1px solid #3d3d3d}
        .settings-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .settings-tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:nowrap;align-items:center}
    .settings-tab{padding:8px 14px;background:#3d3d3d;border-radius:6px;font-size:13px;cursor:pointer;font-weight:600;transition:.15s;flex:1;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .settings-tab.active,.settings-tab:hover{background:#8b4d8b;color:#fff}
        .settings-panel{display:none;gap:16px;flex-wrap:wrap}
        .settings-panel.active{display:flex}
        .setting-item{flex:1 1 240px;background:#1f1f1f;border:1px solid #3d3d3d;padding:12px 14px;border-radius:10px;display:flex;flex-direction:column;gap:8px;min-width:220px}
        .setting-item h4{font-size:14px;margin:0;font-weight:600;color:#fff}
        .setting-item small{font-size:11px;color:#b9b9b9}
        .setting-item input[type=range]{width:100%}
        .toggle{width:44px;height:24px;border-radius:20px;background:#555;position:relative;cursor:pointer;transition:.2s}
        .toggle::after{content:"";position:absolute;width:20px;height:20px;background:#fff;border-radius:50%;top:2px;left:2px;transition:.2s}
        .toggle.active{background:#8b4d8b}
        .toggle.active::after{transform:translateX(20px)}
        select, input[type=color]{background:#2c2c2c;color:#fff;border:1px solid #555;padding:6px 8px;border-radius:6px;font-family:inherit}
    .close-btn{background:#3d3d3d;border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
    .close-btn:hover{background:#555}
    /* Settings gear button unified */
    .settings-btn{background:#3d3d3d;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;display:flex;align-items:center}
    .settings-btn:hover{background:#4a4a4a}
        @media (max-width:700px){#chessboard.chessboard{--board-size:90vw}.game-area{flex:1 1 100%}.header-left{gap:16px}.nav-links{gap:12px}}
    /* Ensure toggles in settings modal receive pointer events and sit above overlays */
    #settingsOverlay .toggle{position:relative;z-index:3101;pointer-events:auto}
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a class="logo" href="/">ChessVerse</a>
            <nav class="nav-links">
                <a href="/play">Gioca Online</a>
                <a href="/bot">Bot Arena</a>
                <a href="/analysis">Analizza</a>
            </nav>
        </div>
        <div class="header-right" style="display:flex;align-items:center;gap:8px;">
            <a href="#" class="settings-btn" title="Impostazioni" onclick="openSettings();return false;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.48.48 0 0 0-.48-.41h-3.84a.48.48 0 0 0-.47.41l-.36 2.54c-.59.24-1.13.56-1.62.94l-2.39-.96a.5.5 0 0 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58A7.3 7.3 0 0 0 4.8 12c0 .31.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.5.5 0 0 0-.12-.61l-2.03-1.58ZM12 15.6A3.6 3.6 0 0 1 8.4 12 3.6 3.6 0 0 1 12 8.4 3.6 3.6 0 0 1 15.6 12 3.6 3.6 0 0 1 12 15.6Z"/>
                </svg>
            </a>
            <a href="/login" class="btn btn-primary">Accedi</a>
        </div>
    </div>
    <main>
        <section class="game-area">
            <div class="board-wrapper">
                <div class="board-container">
                    <div id="chessboard" class="chessboard"></div>
                </div>
                <canvas id="annotations-canvas"></canvas>
            </div>
            <div id="game-status">Turno del Bianco</div>
            <div class="controls">
                <button onclick="resetGame()">Reset</button>
            </div>
        </section>
    </main>

    <!-- PROMOTION -->
    <div id="promotionOverlay" class="dialog-overlay">
        <div class="dialog">
            <h3>Promozione</h3>
            <p>Scegli il pezzo</p>
            <div class="promotion-grid" id="promotionChoices"></div>
        </div>
    </div>

    <!-- GAME OVER -->
    <div id="gameOverOverlay" class="dialog-overlay">
        <div class="dialog">
            <h2 id="gameOverTitle">Fine partita</h2>
            <p id="gameOverDetail"></p>
            <div style="margin-top:18px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                <button onclick="resetGame();hideGameOver()">Nuova Partita</button>
                <button style="background:#444" onclick="hideGameOver()">Chiudi</button>
            </div>
        </div>
    </div>

    <script th:inline="none">
    // Guard: avoid redeclaring the engine if another template already loaded it
    if(window.__chessverse_engine_loaded){ console.debug('chess engine already loaded - skipping duplicate'); }
    else {
    // ======= CONFIG =======
    const START_FEN = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
    const UNICODE = {K:'\u2654',Q:'\u2655',R:'\u2656',B:'\u2657',N:'\u2658',P:'\u2659',k:'\u265A',q:'\u265B',r:'\u265C',b:'\u265D',n:'\u265E',p:'\u265F'}; // usato nel popup promozione
    const state = { fen: START_FEN, selected:null, lastFrom:null, lastTo:null, cache:new Map(), gameOver:false, winner:null };
    const arrows = []; // {from:'e2', to:'e4', color?:'red'}
    const highlights = new Set(); // Set di square names (.highlight)
    const other=c=>c==='white'?'black':'white';
    const sq=(r,c)=>String.fromCharCode(97+c)+(8-r);
    const pos=s=>[8-parseInt(s[1]), s.charCodeAt(0)-97];
    const pColor=p=>p===p.toUpperCase()? 'white':'black';

    function parseFen(f){ const p=f.split(' '); return { board: p[0].split('/').map(r=>{const out=[]; for(const c of r){ if(/\d/.test(c)) for(let i=0;i<+c;i++) out.push(null); else out.push(c);} return out;}), active:p[1]==='w'?'white':'black', castling:p[2], ep:p[3]==='-'?null:p[3], half:+p[4]||0, full:+p[5]||1 }; }
    function boardToFen(b){return b.map(r=>{let s='',n=0; for(const c of r){ if(!c) n++; else { if(n){s+=n;n=0;} s+=c;} } if(n) s+=n; return s;}).join('/');}
    function composeFen(o){return [boardToFen(o.board), o.active==='white'?'w':'b', o.castling||'-', o.ep||'-', o.half, o.full].join(' ');}

    function generateLegalMoves(f){ if(state.cache.has(f)) return state.cache.get(f); const st=parseFen(f); const color=st.active; const opp=other(color); let kSq=null; const pseudo=[]; for(let r=0;r<8;r++) for(let c=0;c<8;c++){const pc=st.board[r][c]; if(pc && pc.toLowerCase()==='k' && pColor(pc)===color) kSq=sq(r,c);} for(let r=0;r<8;r++) for(let c=0;c<8;c++){ const pc=st.board[r][c]; if(!pc||pColor(pc)!==color) continue; const from=sq(r,c); const l=pc.toLowerCase(); if(l==='p'){ const dir=color==='white'?-1:1; const start=color==='white'?6:1; const one=r+dir; if(one>=0&&one<8 && !st.board[one][c]){ pseudo.push({from,to:sq(one,c),piece:pc}); if(r===start && !st.board[r+2*dir][c]) pseudo.push({from,to:sq(r+2*dir,c),piece:pc,epTarget:sq(one,c)});} for(const dc of [-1,1]){ const tr=r+dir, tc=c+dc; if(tr<0||tr>7||tc<0||tc>7) continue; if(st.board[tr][tc] && pColor(st.board[tr][tc])===opp) pseudo.push({from,to:sq(tr,tc),piece:pc}); } if(st.ep){ const [er,ec]=pos(st.ep); if(er===r+dir && Math.abs(ec-c)===1) pseudo.push({from,to:sq(er,ec),piece:pc,enPassant:true}); } } else if(l==='n'){ const d = [ [2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2],[1,-2],[2,-1] ]; for(const [dr,dc] of d){ const tr=r+dr,tc=c+dc; if(tr<0||tr>7||tc<0||tc>7) continue; const t=st.board[tr][tc]; if(!t||pColor(t)===opp) pseudo.push({from,to:sq(tr,tc),piece:pc}); } } else if(l==='b'||l==='r'||l==='q'){ const dirs=[]; if(l!=='r') dirs.push([1,1],[1,-1],[-1,1],[-1,-1]); if(l!=='b') dirs.push([1,0],[-1,0],[0,1],[0,-1]); for(const [dr,dc] of dirs){ let tr=r+dr,tc=c+dc; while(tr>=0&&tr<8&&tc>=0&&tc<8){ const t=st.board[tr][tc]; if(!t) pseudo.push({from,to:sq(tr,tc),piece:pc}); else { if(pColor(t)===opp) pseudo.push({from,to:sq(tr,tc),piece:pc}); break;} tr+=dr; tc+=dc; } } } else if(l==='k'){ for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){ if(!dr&&!dc) continue; const tr=r+dr,tc=c+dc; if(tr<0||tr>7||tc<0||tc>7) continue; const t=st.board[tr][tc]; if(!t||pColor(t)===opp) pseudo.push({from,to:sq(tr,tc),piece:pc}); } if(!isAttacked(st,kSq,color)){ if(st.castling.includes(color==='white'?'K':'k')) if(!st.board[r][c+1]&&!st.board[r][c+2] && !isAttacked(st,sq(r,c+1),color)&&!isAttacked(st,sq(r,c+2),color)) pseudo.push({from,to:sq(r,c+2),piece:pc,castle:'king'}); if(st.castling.includes(color==='white'?'Q':'q')) if(!st.board[r][c-1]&&!st.board[r][c-2]&&!st.board[r][c-3] && !isAttacked(st,sq(r,c-1),color)&&!isAttacked(st,sq(r,c-2),color)) pseudo.push({from,to:sq(r,c-2),piece:pc,castle:'queen'}); } } }
        const legal=[]; for(const m of pseudo){ const newSt=applyPseudo(st,m); if(!kingSafe(newSt,color)) continue; if(m.piece==='P'&&m.to[1]==='8'){['Q','R','B','N'].forEach(pr=>legal.push({...m,promotion:pr})); continue;} if(m.piece==='p'&&m.to[1]==='1'){['q','r','b','n'].forEach(pr=>legal.push({...m,promotion:pr})); continue;} legal.push(m);} state.cache.set(f,legal); return legal; }
    function kingSafe(st,color){ let k=null; for(let r=0;r<8;r++) for(let c=0;c<8;c++){ const p=st.board[r][c]; if(p&&p.toLowerCase()==='k'&&pColor(p)===color) k=sq(r,c);} return !isAttacked(st,k,color); }
    function isAttacked(st,s,color){
        const opp=other(color); const [r,c]=pos(s);
        const dir=opp==='white'?-1:1;
        // pawn
        for(const dc of [-1,1]){ const rr=r+dir, cc=c+dc; if(rr>=0&&rr<8&&cc>=0&&cc<8){ const p=st.board[rr][cc]; if(p&&p.toLowerCase()==='p'&&pColor(p)===opp) return true; } }
        // knights
    const N = [ [2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2],[1,-2],[2,-1] ];
        for(const [dr,dc] of N){ const rr=r+dr,cc=c+dc; if(rr<0||rr>7||cc<0||cc>7) continue; const p=st.board[rr][cc]; if(p&&p.toLowerCase()==='n'&&pColor(p)===opp) return true; }
        // sliding pieces
        const rays=[ [1,0,['r','q']],[-1,0,['r','q']],[0,1,['r','q']],[0,-1,['r','q']], [1,1,['b','q']],[-1,1,['b','q']],[1,-1,['b','q']],[-1,-1,['b','q']] ];
        for(const [dr,dc,types] of rays){ let rr=r+dr,cc=c+dc; while(rr>=0&&rr<8&&cc>=0&&cc<8){ const p=st.board[rr][cc]; if(p){ if(pColor(p)===opp && types.includes(p.toLowerCase())) return true; break;} rr+=dr; cc+=dc; } }
        // king
        for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){ if(!dr&&!dc) continue; const rr=r+dr,cc=c+dc; if(rr<0||rr>7||cc<0||cc>7) continue; const p=st.board[rr][cc]; if(p&&p.toLowerCase()==='k'&&pColor(p)===opp) return true; }
        return false;
    }
    function applyPseudo(st,m){ const ns={...st, board: st.board.map(r=>r.slice())}; const [fr,fc]=pos(m.from); const [tr,tc]=pos(m.to); const piece=ns.board[fr][fc]; ns.board[fr][fc]=null; if(m.enPassant){ const capR= piece==='P'? tr+1: tr-1; ns.board[capR][tc]=null; } if(m.castle==='king'){ ns.board[tr][tc]=piece; ns.board[tr][tc-1]=ns.board[tr][7]; ns.board[tr][7]=null; } else if(m.castle==='queen'){ ns.board[tr][tc]=piece; ns.board[tr][tc+1]=ns.board[tr][0]; ns.board[tr][0]=null; } else { ns.board[tr][tc]= m.promotion ? (pColor(piece)==='white'? m.promotion : m.promotion.toLowerCase()) : piece; } let rights=ns.castling.replace(/-/,''); if(rights){ if(m.from==='a1'||m.to==='a1') rights=rights.replace('Q',''); if(m.from==='h1'||m.to==='h1') rights=rights.replace('K',''); if(m.from==='a8'||m.to==='a8') rights=rights.replace('q',''); if(m.from==='h8'||m.to==='h8') rights=rights.replace('k',''); } if(piece.toLowerCase()==='k'){ rights=rights.replace(pColor(piece)==='white'?'K':'k',''); rights=rights.replace(pColor(piece)==='white'?'Q':'q',''); } ns.castling=rights||'-'; ns.ep = m.epTarget || (m.enPassant? null:null); ns.active=other(st.active); ns.half = piece.toLowerCase()==='p'?0:st.half+1; if(ns.active==='white') ns.full=st.full+1; return ns; }

    function pieceClass(ch){ const white = ch===ch.toUpperCase(); const typeMap={k:'king',q:'queen',r:'rook',b:'bishop',n:'knight',p:'pawn'}; return (white?'white ':'black ')+typeMap[ch.toLowerCase()]; }
    function clearAnnotations(){ if(arrows.length||highlights.size){ arrows.length=0; highlights.clear(); arrowRemoveStart=null; redrawAnnotations(); updateHighlightDom(); }}
    function render(){ const el=document.getElementById('chessboard'); el.innerHTML=''; const st=parseFen(state.fen); const highlightLast = (typeof getSetting === 'function' ? getSetting('highlightLastMove') : true); for(let r=0;r<8;r++) for(let c=0;c<8;c++){ const square=document.createElement('div'); square.className='square '+(((r+c)%2===0)?'light':'dark'); const name=sq(r,c); square.dataset.square=name; if(highlightLast && (state.lastFrom===name||state.lastTo===name)) square.classList.add('last-move'); if(highlights.has(name)) square.classList.add('highlight'); const piece=st.board[r][c]; if(piece){ const pc=document.createElement('div'); pc.className='piece '+pieceClass(piece); pc.draggable=true; pc.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',name); state.dragFrom=name;});
            pc.addEventListener('dragend',()=>{state.dragFrom=null;});
            square.appendChild(pc);
        }
        square.addEventListener('click',e=>{ const empty=!piece; // left click: never highlight
            if(arrows.length || highlights.size){ clearAnnotations(); }
            arrowRemoveStart=null; renderArrowRemoveMarker();
            onSquare(name);
            if(empty && !state.selected) render();
        });
        square.addEventListener('dragover',e=>e.preventDefault());
        square.addEventListener('drop',e=>{e.preventDefault(); if(state.dragFrom) tryMove(state.dragFrom,name);});
        square.addEventListener('mousedown',e=>onMouseDownSquare(e,name));
        square.addEventListener('mouseup',e=>onMouseUpSquare(e,name));
        el.appendChild(square);} if(state.selected){ const showMoves=(typeof getSetting === 'function' ? getSetting('showLegalMoves') : true); if(showMoves){ const moves=generateLegalMoves(state.fen).filter(m=>m.from===state.selected); moves.forEach(m=>{ const target=document.querySelector(`[data-square="${m.to}"]`); if(target){ target.classList.add('possible-move'); if(target.querySelector('.piece')) target.classList.add('occupied'); }}); } const selEl=document.querySelector(`[data-square="${state.selected}"]`); if(selEl) selEl.classList.add('selected'); } updateStatus(); if(window.applyBoardTheme && !render._themeApplied){ applyBoardTheme((typeof getSetting === 'function' ? getSetting('boardTheme') : 'brown')); render._themeApplied=true; } applyHighlightSettings(); redrawAnnotations(); renderArrowRemoveMarker(); }

    // ===== Evidenziazione Celle =====
    function toggleHighlight(s){ if(highlights.has(s)) highlights.delete(s); else highlights.add(s); updateHighlightDom(); }
    function updateHighlightDom(){ document.querySelectorAll('.square.highlight').forEach(el=>{ const sqName=el.dataset.square; if(!highlights.has(sqName)) el.classList.remove('highlight'); }); highlights.forEach(sqName=>{ const el=document.querySelector(`[data-square="${sqName}"]`); if(el) el.classList.add('highlight'); }); applyHighlightSettings(); }
    function applyHighlightSettings(){
        let colorHex='#f7f769', op=.6; if(typeof getSetting==='function'){ colorHex=getSetting('highlightColor')||colorHex; const raw=getSetting('highlightOpacity'); if(raw!=null) op=raw/100; }
        const r=parseInt(colorHex.slice(1,3),16), g=parseInt(colorHex.slice(3,5),16), b=parseInt(colorHex.slice(5,7),16);
        let stEl=document.getElementById('highlight-dynamic-style');
        if(!stEl){ stEl=document.createElement('style'); stEl.id='highlight-dynamic-style'; document.head.appendChild(stEl); }
        stEl.textContent=`
        .square.highlight::before{content:'';position:absolute;inset:0;pointer-events:none;z-index:100 !important;
                background: radial-gradient(circle at center, transparent 0 74%, rgba(${r},${g},${b},${op}) 60% 100%);
        }
        .square.possible-move:not(.occupied)::after{content:"";position:absolute;width:64%;height:34%;background:rgba(0,0,0,0);border-radius:50%;box-shadow:0 0 0 4px rgba(0,0,0,0.0);pointer-events:none;}
    `;
    }

    // ===== Frecce =====
    let arrowDragStart=null; // right button drag create (start square)
    let removeArrowDragStart=null; // left drag removal (optional legacy)
    let arrowRemoveStart=null; // sequential removal start (legacy)
    function onMouseDownSquare(e,name){
    if(e.button===2){ arrowDragStart=name; }
        else if(e.button===0) removeArrowDragStart=name;
    }
    function onMouseUpSquare(e,name){
        // Right button logic (annotazioni)
        if(e.button===2 && arrowDragStart){
            const from=arrowDragStart; const to=name;
            if(from!==to){ toggleArrow(from,to); }
            else { toggleHighlight(from); }
            arrowDragStart=null;
            // Deseleziona eventuale pezzo selezionato
            if(state.selected){ state.selected=null; }
            render(); // include redrawAnnotations
            return;
        }
        // Left button drag removal (optional)
        if(e.button===0 && removeArrowDragStart){ const from=removeArrowDragStart; const to=name; if(from!==to){ if(removeArrowBetween(from,to)) drawArrows(); } removeArrowDragStart=null; }
    }
    function toggleArrow(from,to){ const idx=arrows.findIndex(a=>a.from===from&&a.to===to); if(idx>=0) arrows.splice(idx,1); else arrows.push({from,to}); }
    function removeArrowBetween(a,b){ const idx=arrows.findIndex(ar=> (ar.from===a&&ar.to===b)||(ar.from===b&&ar.to===a)); if(idx>=0){ arrows.splice(idx,1); drawArrows(); return true;} return false; }
    function renderArrowRemoveMarker(){ document.querySelectorAll('.square.arrow-remove-start').forEach(el=>el.classList.remove('arrow-remove-start')); if(arrowRemoveStart){ const el=document.querySelector(`[data-square="${arrowRemoveStart}"]`); if(el) el.classList.add('arrow-remove-start'); } }
    function updateArrowStartMarker(){}
    function redrawAnnotations(){ const canvas=document.getElementById('annotations-canvas'); if(!canvas) return; // size canvas
        const board=document.getElementById('chessboard'); const rect=board.getBoundingClientRect(); canvas.width=rect.width; canvas.height=rect.height; const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); const squareSize=canvas.width/8; const scaleFactor=squareSize/70; arrows.forEach(a=>{ drawArrow(ctx,a.from,a.to,a.color||'main',canvas,scaleFactor); }); }
    function drawArrow(ctx,from,to,colorKey,canvas,scaleFactor){
    const [fr,fc]=pos(from); const [tr,tc]=pos(to);
    const squareSize=canvas.width/8;
    const fromX=(fc+0.5)*squareSize;
    const fromY=(fr+0.5)*squareSize;
    const toX=(tc+0.5)*squareSize;
    const toY=(tr+0.5)*squareSize;
    // Riconosci se è una mossa da cavallo
    const dr=Math.abs(fr-tr), dc=Math.abs(fc-tc);
    const isKnight=(dr===2&&dc===1)||(dr===1&&dc===2);
        let arrowColor;
        if(colorKey==='main'||!colorKey){
            arrowColor=(typeof getSetting==='function'? (getSetting('arrowColor')||'#8b4d8b'):'#8b4d8b');
        } else {
            const colors={red:'#e74c3c',green:'#27ae60',blue:'#3498db',yellow:'#f1c40f',orange:'#e67e22',purple:'#9b59b6'};
            arrowColor=colors[colorKey]||'#8b4d8b';
        }
        const opacity=(typeof getSetting==='function'? (getSetting('arrowOpacity')||80)/100:0.8);
        ctx.globalAlpha=opacity;
        ctx.strokeStyle=arrowColor;
        ctx.fillStyle=arrowColor;
        const baseThickness=(typeof getSetting==='function'? (getSetting('arrowThickness')||12):12);
        const thickness=baseThickness*scaleFactor;
        ctx.lineWidth=thickness;
        ctx.lineCap='round';
        const angle=Math.atan2(toY-fromY,toX-fromX);
    // La punta cresce con lo spessore
    const arrowLength=(24 + thickness*1.2);
    const baseWidth=arrowLength * 1.2;
        const arrowAngle=Math.PI/7;
        if(isKnight){
            // Calcola punto intermedio a L
            let midX, midY;
            if(dr===2&&dc===1){
                // Mossa verticale lunga, poi orizzontale corta
                midX=fromX;
                midY=toY;
            }else{
                // Mossa orizzontale lunga, poi verticale corta
                midX=toX;
                midY=fromY;
            }
            // Calcola punto dove inizia la punta
            const dx=toX-midX, dy=toY-midY;
            const len=Math.sqrt(dx*dx+dy*dy);
            const shorten=arrowLength*0.6;
            const tipX=toX-shorten*(dx/len);
            const tipY=toY-shorten*(dy/len);
            // Disegna i due segmenti a L
            ctx.beginPath();
            ctx.moveTo(fromX,fromY);
            ctx.lineTo(midX,midY);
            ctx.lineTo(tipX,tipY);
            ctx.stroke();
            // Punta
            const angleKnight=Math.atan2(toY-midY,toX-midX);
            const base1X=tipX + baseWidth/2 * Math.cos(angleKnight + Math.PI/2);
            const base1Y=tipY + baseWidth/2 * Math.sin(angleKnight + Math.PI/2);
            const base2X=tipX + baseWidth/2 * Math.cos(angleKnight - Math.PI/2);
            const base2Y=tipY + baseWidth/2 * Math.sin(angleKnight - Math.PI/2);
            const headX=tipX + arrowLength * Math.cos(angleKnight);
            const headY=tipY + arrowLength * Math.sin(angleKnight);
            ctx.beginPath();
            ctx.moveTo(headX, headY);
            ctx.lineTo(base1X, base1Y);
            ctx.lineTo(base2X, base2Y);
            ctx.closePath();
            ctx.fill();
            ctx.globalAlpha=1;
            return;
        }
        // ...altrimenti freccia normale
        const angleNorm=Math.atan2(toY-fromY,toX-fromX);
        const shorten=arrowLength * 0.6;
        const adjX=toX-shorten*Math.cos(angleNorm);
        const adjY=toY-shorten*Math.sin(angleNorm);
        ctx.beginPath();
        ctx.moveTo(fromX,fromY);
        ctx.lineTo(adjX,adjY);
        ctx.stroke();
        const tipX=adjX;
        const tipY=adjY;
        const base1X=tipX + baseWidth/2 * Math.cos(angleNorm + Math.PI/2);
        const base1Y=tipY + baseWidth/2 * Math.sin(angleNorm + Math.PI/2);
        const base2X=tipX + baseWidth/2 * Math.cos(angleNorm - Math.PI/2);
        const base2Y=tipY + baseWidth/2 * Math.sin(angleNorm - Math.PI/2);
        const headX=tipX + arrowLength * Math.cos(angleNorm);
        const headY=tipY + arrowLength * Math.sin(angleNorm);
        ctx.beginPath();
        ctx.moveTo(headX, headY);
        ctx.lineTo(base1X, base1Y);
        ctx.lineTo(base2X, base2Y);
        ctx.closePath();
        ctx.fill();
        ctx.globalAlpha=1;
    }
    document.addEventListener('contextmenu',e=>{ if(e.target.closest && e.target.closest('#chessboard')) e.preventDefault(); });
    window.addEventListener('resize',()=>{ redrawAnnotations(); });

    function onSquare(sqName){ if(state.gameOver) return; if(state.selected){ if(state.selected===sqName){ state.selected=null; render(); return;} if(!tryMove(state.selected,sqName)){ const st=parseFen(state.fen); const [r,c]=pos(sqName); const pc=st.board[r][c]; if(pc && pColor(pc)===parseFen(state.fen).active){ state.selected=sqName; render(); } } } else { const st=parseFen(state.fen); const [r,c]=pos(sqName); const pc=st.board[r][c]; if(pc && pColor(pc)===st.active){ state.selected=sqName; render(); } } }

    function tryMove(from,to){ const legal=generateLegalMoves(state.fen); const mv=legal.find(m=>m.from===from&&m.to===to); if(!mv){ flashInvalid(to); return false;} if(mv.promotion){ showPromotion(from,to,mv); return true;} applyMove(mv); return true; }
    function flashInvalid(sqName){ const el=document.querySelector(`[data-square="${sqName}"]`); if(!el) return; el.classList.add('invalid'); setTimeout(()=>el.classList.remove('invalid'),350); }
    function applyMove(m){
        // Defensive: validate move against current legal moves to prevent stale/premove/bot illegal moves
        try{ const legal = generateLegalMoves(state.fen) || []; const ok = legal.some(lm=> lm.from===m.from && lm.to===m.to && ( (lm.promotion && m.promotion && lm.promotion.toUpperCase()===m.promotion.toUpperCase()) || (!lm.promotion && !m.promotion) )); if(!ok){ flashInvalid(m.to); console.warn('Blocked illegal/stale move', m); return false; } }catch(e){ console.warn('applyMove validation error', e); }
        const st=parseFen(state.fen);
        const ns=applyPseudo(st,m);
        state.lastFrom=m.from;
        state.lastTo=m.to;
        state.fen=composeFen(ns);
        state.selected=null;
        state.cache.clear();
        // play move/capture sound (if audio helpers are available)
        try{ const [tr,tc]=pos(m.to); const captured = !!st.board[tr][tc]; if(typeof playMoveSound==='function') playMoveSound(captured ? 'capture' : 'move'); }catch(e){}
        checkEnd(); render();
        return true;
    }

    function checkEnd(){ const moves=generateLegalMoves(state.fen); const st=parseFen(state.fen); const color=st.active; let king=null; for(let r=0;r<8;r++) for(let c=0;c<8;c++){ const p=st.board[r][c]; if(p&&p.toLowerCase()==='k'&&pColor(p)===color) king=sq(r,c); } const inCheck=isAttacked(st,king,color); if(moves.length===0){ state.gameOver=true; if(inCheck){ state.winner=other(color); showGameOver(`${state.winner==='white'?'Bianco':'Nero'} vince!`,'Scacco Matto'); } else { showGameOver('Patta','Stallo'); } } }
    function updateStatus(){ if(state.gameOver){ document.getElementById('game-status').textContent = state.winner ? (state.winner==='white'?'Bianco':'Nero')+' Vince!' : 'Patta'; return;} const active=parseFen(state.fen).active; let king=null; const st=parseFen(state.fen); for(let r=0;r<8;r++) for(let c=0;c<8;c++){ const p=st.board[r][c]; if(p&&p.toLowerCase()==='k'&&pColor(p)===st.active) king=sq(r,c);} const inCheck=isAttacked(st,king,st.active); document.getElementById('game-status').textContent = 'Turno del '+(active==='white'?'Bianco':'Nero') + (inCheck?' (Scacco)':''); }

    function showPromotion(from,to,proto){
        const overlay=document.getElementById('promotionOverlay');
        const grid=document.getElementById('promotionChoices');
        grid.innerHTML='';
        const isWhite=parseFen(state.fen).active==='white';
        const list=isWhite?['Q','R','B','N']:['q','r','b','n'];
        list.forEach(p=>{
            const div=document.createElement('div');
            div.className='promo-choice';
            div.textContent=UNICODE[p];
            div.onclick=()=>{
                overlay.style.display='none';
                try{
                    const legal = generateLegalMoves(state.fen) || [];
                    const found = legal.find(m=>m.from===from && m.to===to && m.promotion && (m.promotion.toUpperCase()===p.toUpperCase() || m.promotion===p));
                    if(found){ applyMove({...proto,promotion:p.toUpperCase()}); }
                    else { flashInvalid(to); }
                }catch(e){ console.warn('promotion validation failed',e); applyMove({...proto,promotion:p.toUpperCase()}); }
            };
            grid.appendChild(div);
        });
        overlay.style.display='flex';
    }
    function hidePromotion(){ document.getElementById('promotionOverlay').style.display='none'; }
    function showGameOver(title,detail){ document.getElementById('gameOverTitle').textContent=title; document.getElementById('gameOverDetail').textContent=detail; document.getElementById('gameOverOverlay').style.display='flex'; }
    function hideGameOver(){ document.getElementById('gameOverOverlay').style.display='none'; }
    function resetGame(){ state.fen=START_FEN; state.selected=null; state.lastFrom=null; state.lastTo=null; state.cache.clear(); state.gameOver=false; state.winner=null; hidePromotion(); hideGameOver(); render(); }
    // --- Audio helpers (WebAudio) ---
    function safeGetSetting(key, defVal){ try{ if(typeof getSetting==='function') return getSetting(key); }catch(e){} try{ const raw=localStorage.getItem('chessverse_settings'); if(raw){ const s=JSON.parse(raw); if(s && Object.prototype.hasOwnProperty.call(s,key)) return s[key]; } }catch(e){} return defVal; }
    let _audioCtx=null, _masterGain=null, _audioInited=false;
    function initAudio(){ if(_audioInited) return; try{ _audioCtx = new (window.AudioContext || window.webkitAudioContext)(); _masterGain = _audioCtx.createGain(); const vol = (safeGetSetting('masterVolume',70)||70)/100; _masterGain.gain.value = Math.min(1, Math.max(0, vol)); _masterGain.connect(_audioCtx.destination); _audioInited=true; }catch(e){ _audioInited=false; }}
    function playTone(freq, duration=0.06, type='sine', gain=0.08){ if(!_audioInited) initAudio(); if(!_audioInited) return; try{ const o=_audioCtx.createOscillator(); const g=_audioCtx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value = gain * ((safeGetSetting('masterVolume',70)||70)/100); o.connect(g); g.connect(_masterGain); o.start(); o.stop(_audioCtx.currentTime + duration); setTimeout(()=>{ try{ o.disconnect(); g.disconnect(); }catch(e){} }, (duration+0.05)*1000); }catch(e){} }
    function playMoveSound(kind){ try{ if(!safeGetSetting('soundsEnabled', true)) return; if(kind==='capture'){ if(!safeGetSetting('captureSounds', true)) return; playTone(220,0.14,'sawtooth',0.18); playTone(440,0.06,'sine',0.08); } else { if(!safeGetSetting('moveSounds', true)) return; playTone(420,0.06,'square',0.10); playTone(840,0.03,'sine',0.06); } }catch(e){}
    }

    document.addEventListener('DOMContentLoaded',()=>{ initAudio(); render(); });
    window.addEventListener('storage',()=>{ render(); });
    // React to settings changes in the same tab (dispatched by settings.js)
    window.addEventListener('chessverse:settingsChanged', function(e){
        try{
            // reapply highlight visuals and redraw arrows
            if(typeof applyHighlightSettings === 'function') applyHighlightSettings();
            if(typeof redrawAnnotations === 'function') redrawAnnotations();
            // ensure the board re-renders (updates classes like possible-move etc.)
            if(typeof render === 'function') render();
        }catch(err){ /* ignore */ }
    });
    // mark engine loaded to prevent duplicate redeclaration in other templates
    window.__chessverse_engine_loaded = true;
    }
    </script>

    <!-- SETTINGS OVERLAY (minimal to work with settings.js) -->
    <div id="settingsOverlay">
        <div class="settings-modal">
            <div class="settings-header">
                <h2 style="font-size:18px;font-weight:700;color:#fff;margin:0">Impostazioni</h2>
                <button class="close-btn" onclick="closeSettings()">Chiudi</button>
            </div>
                <div class="settings-tabs">
                <div class="settings-tab active" data-tab="general">Play</div>
                <div class="settings-tab" data-tab="display">Display</div>
                <div class="settings-tab" data-tab="audio">Suoni</div>
            </div>
            <!-- PANELS -->
            <div id="general-panel" class="settings-panel active">
                <div class="setting-item">
                    <h4>Mosse Legali</h4><small>Mostra suggerimenti</small>
                    <div id="showLegalMoves" class="toggle active"></div>
                </div>
                <div class="setting-item">
                    <h4>Ultima Mossa</h4><small>Evidenzia</small>
                    <div id="highlightLastMove" class="toggle active"></div>
                </div>
                <div class="setting-item">
                    <h4>Animazione</h4><small>Velocità</small>
                    <select id="moveAnimation"><option value="none">None</option><option value="fast">Veloce</option><option value="normal" selected>Normale</option><option value="slow">Lenta</option></select>
                </div>
            </div>
            <div id="display-panel" class="settings-panel">
                <div class="setting-item">
                    <h4>Tema Scacchiera</h4><small>Colori</small>
                    <select id="boardTheme"><option value="brown" selected>Marrone</option><option value="green">Verde</option><option value="blue">Blu</option><option value="purple">Viola</option><option value="gray">Grigio</option></select>
                </div>
                <div class="setting-item">
                    <h4>Stile Pezzi</h4><small>Seleziona stile</small>
                    <select id="pieceStyle">
                        <option value="classic">Classico (attuale)</option>
                        <option value="pixel">Pixel</option>
                        <option value="outline">Outline</option>
                        <option value="large">Large</option>
                    </select>
                </div>
                <div class="setting-item">
                    <h4>Background</h4><small>Colore</small>
                    <input type="color" id="backgroundColor" value="#312e2b" />
                    <small style="margin-top:8px">Oppure carica un'immagine</small>
                    <input type="file" id="backgroundImage" accept="image/*" />
                </div>
                <div class="setting-item">
                    <h4>Colore Evidenzia</h4><small>Ring</small>
                    <input type="color" id="highlightColor" value="#ffff00" />
                </div>
                <div class="setting-item">
                    <h4>Opacità Evidenzia</h4><small><span id="highlightOpacityValue">85%</span></small>
                    <input type="range" id="highlightOpacity" min="30" max="100" value="85" oninput="document.getElementById('highlightOpacityValue').textContent=this.value+'%'" />
                </div>
                <!-- Frecce -->
                <div class="setting-item">
                    <h4>Colore Frecce</h4><small>Principale</small>
                    <input type="color" id="arrowColor" value="#8b4d8b" />
                </div>
                <div class="setting-item">
                    <h4>Opacità Frecce</h4><small><span id="arrowOpacityValue">80%</span></small>
                    <input type="range" id="arrowOpacity" min="20" max="100" value="80" oninput="document.getElementById('arrowOpacityValue').textContent=this.value+'%'" />
                </div>
                <div class="setting-item">
                    <h4>Spessore Frecce</h4><small><span id="arrowThicknessValue">12px</span></small>
                    <input type="range" id="arrowThickness" min="4" max="32" value="12" oninput="document.getElementById('arrowThicknessValue').textContent=this.value+'px'" />
                </div>
            </div>
            <div id="audio-panel" class="settings-panel">
                <div class="setting-item">
                    <h4>Suoni</h4><small>Abilita</small>
                    <div id="soundsEnabled" class="toggle active"></div>
                </div>
                <div class="setting-item">
                    <h4>Volume</h4><small><span id="masterVolumeValue">70%</span></small>
                    <input type="range" id="masterVolume" min="0" max="100" value="70" oninput="document.getElementById('masterVolumeValue').textContent=this.value+'%'" />
                </div>
                <div class="setting-item">
                    <h4>Mosse</h4><small>Suono mossa</small>
                    <div id="moveSounds" class="toggle active"></div>
                </div>
                <div class="setting-item">
                    <h4>Catture</h4><small>Suono cattura</small>
                    <div id="captureSounds" class="toggle active"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/settings.js"></script>
</body>
</html>
